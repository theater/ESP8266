/*! HABmin 2014-06-20 */
Ext.define("Ext.ux.blockly.Blockly",{extend:"Ext.panel.Panel",closable:!0,layout:"border",toolbox:null,trashcan:!0,header:!1,selectedRecord:null,autoDestroy:!0,initComponent:function(){function a(){if(e=m.getId()+"-body",Blockly.inject(document.getElementById(e),{path:b.blockly.path,collapse:b.blockly.collapse,trashcan:b.blockly.trashcan}),1==b.blockly.toolbox){m.dropZone=Ext.create("Ext.dd.DropZone",Blockly.DIV,{getTargetFromEvent:function(a){return console.log("node in"),a.getTarget("#"+e)},onNodeOver:function(a,c,f){if(console.log("Node mouse move"),2!=Blockly.Block.dragMode_){for(var g=document.getElementById(e),h=-0,i=-0;"BODY"!=g.nodeName;)h+=parseInt(g.offsetTop),i+=parseInt(g.offsetLeft),g=g.parentNode;var j=Blockly.getMainWorkspace().getMetrics();d=Blockly.Json.domToBlock(Blockly.getMainWorkspace(),b.selectedRecord.get("block")),d.moveBy(j.viewLeft+f.xy[0]-i,j.viewTop+f.xy[1]-h);var k={};k.clientX=f.xy[0],k.clientY=f.xy[1],k.button=0,k.stopPropagation=f.stopPropagation,d.onMouseDown_(k),Blockly.Block.dragMode_=2}return Ext.dd.DropZone.prototype.dropAllowed},onNodeDrop:function(a,c,e,f){return Blockly.mainWorkspace.scrollbar=b.scrollbar,null==f.block?!1:(null!=d&&(d=null),!0)}});for(var a=0;a<c.length;a++)c[a].store.each(function(a){var b=Blockly.Json.domToBlock(Blockly.getMainWorkspace(),a.get("block"));if(null==b)console.log("Unable to load block '"+a.get("block")+"'.");else{var c='<svg height="'+b.getHeightWidth().height+'" width="'+(b.getHeightWidth().width+10)+'"><g transform="translate(10)">'+b.getSvgRoot().outerHTML+"</g></svg>";a.set("svg",c),Blockly.getMainWorkspace().clear()}},b)}if(null!=b.blockly.blocks&&""!=b.blockly.blocks&&b.setBlocks(b.blockly.blocks),null!=b.blockly.listeners&&b.blockly.listeners.workspacechanged){var f=new Ext.util.DelayedTask(function(){Ext.fly(Blockly.mainWorkspace.getCanvas()).on("blocklyWorkspaceChange",b.blockly.listeners.workspacechanged)});f.delay(500)}}var b=this,c=[],d=null,e=null,f=null;if(null==b.blockly&&(b.blockly={}),this.items=[],1==b.blockly.toolbox){for(var g=0;g<b.blockly.toolboxCategories.length;g++){for(var h=Ext.create("Ext.data.ArrayStore",{fields:[{name:"category"},{name:"block"},{name:"svg"},{name:"name"}]}),i=0;i<b.blockly.toolboxTools.length;i++)b.blockly.toolboxTools[i].category===b.blockly.toolboxCategories[g].name&&h.add(b.blockly.toolboxTools[i]);var j=Ext.create("Ext.grid.Panel",{title:b.blockly.toolboxCategories[g].title,icon:b.blockly.toolboxCategories[g].icon,tooltip:b.blockly.toolboxCategories[g].tooltip,category:b.blockly.toolboxCategories[g].name,hideHeaders:!0,store:h,collapsible:!1,multiSelect:!1,disableSelection:!0,layout:"fit",viewConfig:{stripeRows:!0,enableTextSelection:!1,markDirty:!1},columns:[{flex:1,dataIndex:"svg"}],listeners:{render:function(a){a.dragZone=Ext.create("Ext.dd.DragZone",a.getEl(),{style:{"background-color":"#f00","padding-left":"0px"},constrain:!1,onMouseDown:function(){console.log("startDrag"),this.setDelta(30,5),b.scrollbar=Blockly.mainWorkspace.scrollbar,Blockly.mainWorkspace.scrollbar=!1},getDragData:function(c){var d=c.getTarget("svg",10);if(d){var e=d.cloneNode(!0);return e.style.width=e.getAttribute("width"),e.id=Ext.id(),a.dragZone.setDelta(0,0),a.dragData={sourceEl:d,repairXY:Ext.fly(d).getXY(),ddel:e,block:b.selectedRecord.get("block")}}},getRepairXY:function(){return Blockly.mainWorkspace.scrollbar=b.scrollbar,null!=d&&(d.dispose(),d=null),this.dragData.repairXY}})},beforecellmousedown:function(a,c,d,e,g,h,i){b.selectedRecord=e,f=i.xy,Blockly.hideChaff(!1)},itemdblclick:function(a,b){null!=b&&Blockly.Json.domToBlock(Blockly.getMainWorkspace(),b.get("block"))}}});c.push(j)}var k=Ext.create("Ext.Panel",{split:!0,border:!0,region:"west",autoDestroy:!0,flex:1,preventHeader:!0,layout:{type:"accordion",hideCollapseTool:!0},listeners:{expand:function(){}},items:c});this.items.push(k)}var l=null;null!=this.tbar&&(l=this.tbar,this.tbar=null);var m=Ext.create("Ext.panel.Panel",{region:"center",tbar:l,layout:"fit",flex:4,autoDestroy:!0,listeners:{afterrender:function(){function b(a){a.preventDefault()}a(),Ext.fly(document.body).on("contextmenu",b)},resize:function(){Blockly.svgResize()},move:function(){}}});this.items.push(m),this.callParent()},listeners:{beforedestroy:function(a){null!=Blockly&&null!=Blockly.getMainWorkspace()&&Blockly.getMainWorkspace().dispose(),a.removeAll(!0)}},setBlocks:function(a){null!=Blockly.getMainWorkspace()&&Blockly.getMainWorkspace().clear(),Blockly.Json.setWorkspace(Blockly.getMainWorkspace(),a)},getBlocks:function(){return Blockly.Json.getWorkspace(Blockly.getMainWorkspace())}});