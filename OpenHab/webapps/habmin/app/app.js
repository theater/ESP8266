/*! HABmin 2014-06-20 */
function loadLanguage(a){moment.lang(a),Ext.Ajax.request({url:"./app/language/"+a+".json",headers:{Accept:"application/json"},success:function(a){var b=Ext.decode(a.responseText);if(null!==b)for(var c in b)language[c]=b[c]},callback:function(){}})}function getReleaseVersion(){Ext.data.JsonP.request({url:gitRepoLink,callbackKey:"callback",success:function(a){if(null!=a&&null!=a.data){for(var b=0,c=0,d="",e=0,f="",g=0;g<a.data.length;g++)a.data[g].draft!==!0&&(a.data[g].tag_name==versionGUI&&(b=Date.parse(a.data[g].published_at)),a.data[g].prerelease===!1?Date.parse(a.data[g].published_at)>c&&(c=a.data[g].published_at,d=a.data[g].tag_name):Date.parse(a.data[g].published_at)>e&&(e=Date.parse(a.data[g].published_at),f=a.data[g].tag_name));var h=Ext.util.Cookies.get("lastPrereleaseNotification");if(null==h&&(h=0),c>b){var i=sprintf(language.newReleaseNotification,f,moment(e).format("D MMM"));handleStatusNotification(NOTIFICATION_INFO,i)}else if(h<(new Date).getTime()-432e6&&e>b){var i=sprintf(language.newPrereleaseNotification,f,moment(e).format("D MMM YYYY"));handleStatusNotification(NOTIFICATION_INFO,i);var h=Ext.util.Cookies.set("lastPrereleaseNotification",(new Date).getTime())}}}})}function checkUserPrefs(){null===userPrefs&&(userPrefs={}),null===userPrefs.messageTimeError&&(userPrefs.messageTimeError=2500),userPrefs.messageTimeError>1e4&&(userPrefs.messageTimeError=2500),userPrefs.messageTimeError<0&&(userPrefs.messageTimeError=2500),null===userPrefs.messageTimeWarning&&(userPrefs.messageTimeWarning=2500),userPrefs.messageTimeWarning>1e4&&(userPrefs.messageTimeWarning=2500),userPrefs.messageTimeWarning<0&&(userPrefs.messageTimeWarning=2500),null===userPrefs.messageTimeSuccess&&(userPrefs.messageTimeSuccess=1500),userPrefs.messageTimeSuccess>1e4&&(userPrefs.messageTimeSuccess=1500),userPrefs.messageTimeSuccess<0&&(userPrefs.messageTimeSuccess=1500)}function handleStatusNotification(a,b){a==NOTIFICATION_OK?Ext.create("widget.uxNotification",{position:"tr",useXAxis:!1,cls:"ux-notification-success",iconCls:"ux-notification-success-icon",closable:!1,title:language.success,html:b,slideInDuration:800,slideBackDuration:1500,autoCloseDelay:3e3,width:250,height:75,slideInAnimation:"bounceOut",slideBackAnimation:"easeIn"}).show():a==NOTIFICATION_ERROR?Ext.create("widget.uxNotification",{position:"tr",useXAxis:!1,cls:"ux-notification-error",iconCls:"ux-notification-error-icon",closable:!0,title:language.error,html:b,slideInDuration:800,slideBackDuration:1500,autoCloseDelay:2e4,width:250,height:75,slideInAnimation:"bounceOut",slideBackAnimation:"easeIn"}).show():a==NOTIFICATION_WARNING?Ext.create("widget.uxNotification",{position:"tr",useXAxis:!1,cls:"ux-notification-warning",iconCls:"ux-notification-warning-icon",closable:!1,title:language.warning,html:b,slideInDuration:800,slideBackDuration:1500,autoCloseDelay:3e3,width:250,height:75,slideInAnimation:"bounceOut",slideBackAnimation:"easeIn"}).show():Ext.create("widget.uxNotification",{position:"tr",useXAxis:!1,cls:"ux-notification-info",iconCls:"ux-notification-info-icon",closable:!1,title:language.information,html:b,slideInDuration:800,slideBackDuration:1500,autoCloseDelay:6e3,width:250,height:75,slideInAnimation:"bounceOut",slideBackAnimation:"easeIn"}).show()}function handleOnlineStatus(a){onlineStatus!=a&&(onlineStatus=a,a==STATUS_ONLINE?(Ext.get("statusicon").dom.src="images/status.png",statusTooltip.update(language.onlineState_Online),handleStatusNotification(NOTIFICATION_OK,language.onlineState_Online)):a==STATUS_BUSY?(Ext.get("statusicon").dom.src="images/status-away.png",statusTooltip.update(language.onlineState_Busy),handleStatusNotification(NOTIFICATION_WARNING,language.onlineState_Busy)):a==STATUS_OFFLINE&&(Ext.get("statusicon").dom.src="images/status-busy.png",statusTooltip.update(language.onlineState_Offline),handleStatusNotification(NOTIFICATION_ERROR,language.onlineState_Offline)))}function doStatus(){var a={run:function(){ajaxLastSuccess<(new Date).getTime()-2500&&0==ajaxOutstandingRequestCount&&(console.log("Request Status"),Ext.Ajax.request({type:"rest",url:HABminBaseURL+"/status",timeout:a.timeout,method:"GET",success:function(b){var c=Ext.decode(b.responseText);null==c?a.statusCount++:a.statusCount=0},failure:function(){a.statusCount++},callback:function(){a.startCnt>0?a.startCnt--:a.errorLimit=2,a.statusCount>=a.errorLimit?(a.timeout=3e4,handleOnlineStatus(STATUS_OFFLINE)):0==a.statusCount&&(a.timeout=2500,handleOnlineStatus(STATUS_ONLINE))}}))},timeout:3e4,interval:5e3,startCnt:6,statusCount:0,errorLimit:6};Ext.TaskManager.start(a)}function getItemTypeIcon(a){var b=itemTypeStore.findExact("name",a);return-1==b?"":itemTypeStore.getAt(b).get("icon")}function createUI(){delete Ext.tip.Tip.prototype.minWidth,Ext.QuickTips.init(),Ext.state.Manager.setProvider(new Ext.state.CookieProvider),Ext.define("CRONRuleModel",{extend:"Ext.data.Model",fields:[{name:"rule"},{name:"label"}]}),cronRuleStore=Ext.create("Ext.data.ArrayStore",{model:"CRONRuleModel"}),cronRuleStore.loadData(cronRuleArray),Ext.define("TranslationServiceModel",{extend:"Ext.data.Model",fields:[{name:"name"},{name:"label"}]}),translationServiceStore=Ext.create("Ext.data.ArrayStore",{model:"TranslationServiceModel"}),translationServiceStore.loadData(translationServiceArray),Ext.define("ItemTypeModel",{extend:"Ext.data.Model",fields:[{name:"name"},{name:"label"},{name:"icon"}]}),itemTypeStore=Ext.create("Ext.data.ArrayStore",{model:"ItemTypeModel"}),itemTypeStore.loadData(itemTypeArray),Ext.define("PersistenceServiceModel",{extend:"Ext.data.Model",fields:[{name:"name"},{name:"actions"},{name:"strategies"}]}),persistenceServiceStore=Ext.create("Ext.data.JsonStore",{model:"PersistenceServiceModel",proxy:{type:"rest",url:HABminBaseURL+"/config/persistence/services",reader:{type:"json",root:"services"},headers:{Accept:"application/json"},pageParam:void 0,startParam:void 0,sortParam:void 0,limitParam:void 0},autoLoad:!0,listeners:{load:function(a){for(var b=Ext.getCmp("persistenceServiceMenu"),c=0;c<a.getCount();c++){var d=[].concat(a.getAt(c).get("actions"));if(d.indexOf("Read")){""==persistenceService&&(persistenceService=a.getAt(c).get("name"));var e={};e.text=a.getAt(c).get("name"),e.icon="images/database-sql.png",e.disabled=!1,b.add(e)}}var f=Ext.getCmp("persistenceServiceSelect");null!=f&&(f.setText(persistenceService),persistenceItemStore.filterItems(persistenceService))}}}),chartStore=Ext.create("Ext.data.Store",{fields:["id","name","icon"],proxy:{type:"rest",url:HABminBaseURL+"/persistence/charts",reader:{type:"json",root:"chart"},headers:{Accept:"application/json"},pageParam:void 0,startParam:void 0,sortParam:void 0,limitParam:void 0},autoLoad:!0}),Ext.define("PersistenceItemModel",{extend:"Ext.data.Model",fields:[{name:"name"},{name:"label"},{name:"unit"},{name:"format"},{name:"state"},{name:"icon"},{name:"type"},{name:"services"},{name:"groups"}]}),persistenceItemStore=Ext.create("Ext.data.ArrayStore",{model:"PersistenceItemModel",proxy:{type:"rest",url:HABminBaseURL+"/persistence/items",reader:{type:"json",root:"items"},headers:{Accept:"application/json"},pageParam:void 0,startParam:void 0,sortParam:void 0,limitParam:void 0},autoLoad:!0,filterItems:function(a){persistenceItemStore.filterBy(function(b){var c=[].concat(b.get("services"));return-1!=c.indexOf(a)?!0:!1})}}),Ext.define("ItemIconModel",{extend:"Ext.data.Model",fields:[{name:"name"},{name:"menuicon"},{name:"label"},{name:"description"},{name:"height"},{name:"width"}]}),itemIconStore=Ext.create("Ext.data.ArrayStore",{model:"ItemIconModel",proxy:{type:"rest",url:HABminBaseURL+"/config/icons",reader:{type:"json",root:"icon"},headers:{Accept:"application/json"},pageParam:void 0,startParam:void 0,sortParam:void 0,limitParam:void 0},autoLoad:!0}),designStore=Ext.create("Ext.data.JsonStore",{fields:[{name:"id"},{name:"name"}],proxy:{type:"rest",url:HABminBaseURL+"/config/designer",reader:{type:"json",root:"designs"},headers:{Accept:"application/json"},pageParam:void 0,startParam:void 0,sortParam:void 0,limitParam:void 0},autoLoad:!0}),Ext.define("WidgetsModel",{extend:"Ext.data.Model",fields:[{name:"type"},{name:"icon"},{name:"iconCls"}]}),widgetStore=Ext.create("Ext.data.ArrayStore",{model:"WidgetsModel"}),widgetStore.loadData(widgetTypeArray),Ext.define("FormatModel",{extend:"Ext.data.Model",fields:[{name:"format"},{name:"label"}]}),itemFormatStore=Ext.create("Ext.data.ArrayStore",{model:"FormatModel"}),itemFormatStore.loadData(formatLookupArray),Ext.define("ItemConfigModel",{extend:"Ext.data.Model",fields:[{name:"model"},{name:"name"},{name:"type"},{name:"icon"},{name:"type"},{name:"label"},{name:"format"},{name:"units"},{name:"groups"}]}),itemConfigStore=Ext.create("Ext.data.ArrayStore",{model:"ItemConfigModel",proxy:{type:"rest",url:HABminBaseURL+"/config/items",reader:{type:"json",root:"item"},headers:{Accept:"application/json"},pageParam:void 0,startParam:void 0,sortParam:void 0,limitParam:void 0},autoLoad:!0}),Ext.define("SitemapsModel",{extend:"Ext.data.Model",fields:[{name:"icon"},{name:"name"},{name:"label"}]}),sitemapStore=Ext.create("Ext.data.ArrayStore",{model:"SitemapsModel",proxy:{type:"rest",url:HABminBaseURL+"/config/sitemap",reader:{type:"json",root:"sitemap"},headers:{Accept:"application/json"},pageParam:void 0,startParam:void 0,sortParam:void 0,limitParam:void 0},autoLoad:!0}),Ext.define("BindingsModel",{extend:"Ext.data.Model",fields:[{name:"bundle"},{name:"name"},{name:"pid"},{name:"type"},{name:"author"},{name:"version"},{name:"ohversion"},{name:"link"},{name:"osgiVersion"}]}),bindingStore=Ext.create("Ext.data.ArrayStore",{model:"BindingsModel",proxy:{type:"rest",url:HABminBaseURL+"/config/bindings",reader:{type:"json",root:"binding"},headers:{Accept:"application/json"},pageParam:void 0,startParam:void 0,sortParam:void 0,limitParam:void 0},autoLoad:!0});var a=Ext.create("openHAB.config.config"),b=Ext.create("openHAB.graph.graph"),c=Ext.create("openHAB.automation.automation"),d=Ext.create("openHAB.system.system");Ext.define("StatusBar",{extend:"Ext.Component",alias:"widget.onlinestatusbar",html:'<div id="onlineStatus" style="position:absolute;right:5px;top:3px;width:250px;text-align:right"><span id="statustext" style="vertical-align: top;">'+language.mainTab_OnlineStatus+'&nbsp</span><img style="margin-top:-1px;" id="statusicon" src="images/status-offline.png"></div>'});var e=Ext.create("Ext.tab.Panel",{layout:"fit",items:[b,a,c,d],listeners:{render:function(){this.tabBar.add({xtype:"tbfill"},{xtype:"onlinestatusbar"},{border:!1,closable:!1,tooltip:language.mainTab_UserSettings,icon:"images/user-green.png",handler:function(){var a=Ext.create("Ext.data.ArrayStore",{fields:[{name:"code"},{name:"name"},{name:"nativeName"}]});a.loadData(isoLanguages),a.sort("nativeName");var b=Ext.widget("form",{layout:{type:"vbox",align:"stretch"},border:!1,bodyPadding:10,fieldDefaults:{labelAlign:"left",labelWidth:100,labelStyle:"font-weight:bold"},defaults:{margins:"0 0 10 0"},items:[{xtype:"combobox",fieldLabel:language.personalisation_Language,itemId:"language",name:"language",store:a,allowBlank:!1,valueField:"code",displayField:"nativeName",forceSelection:!0,editable:!1,typeAhead:!0,queryMode:"local",value:languageCode},{xtype:"combobox",fieldLabel:language.personalisation_PersistenceStore,itemId:"persistence",name:"persistence",store:persistenceServiceStore,allowBlank:!1,valueField:"name",displayField:"name",forceSelection:!0,editable:!1,typeAhead:!0,queryMode:"local",value:persistenceService}],buttons:[{text:language.cancel,handler:function(){this.up("window").destroy()}},{text:language.save,handler:function(){if(this.up("form").getForm().isValid()){var a=languageCode;languageCode=b.getForm().findField("language").getSubmitValue(),Ext.util.Cookies.set("language",languageCode),persistenceService=b.getForm().findField("persistence").getSubmitValue(),Ext.util.Cookies.set("persistence",persistenceService);var c=Ext.getCmp("persistenceServiceSelect");null!=c&&(c.setText(persistenceService),persistenceItemStore.filterItems(persistenceService)),this.up("window").destroy(),a!=languageCode&&(loadLanguage(languageCode),window.location.reload())}}}]}),c=Ext.widget("window",{header:!1,closeAction:"destroy",width:325,resizable:!1,draggable:!1,modal:!0,layout:{type:"vbox",align:"stretch"},items:[b]});c.show(),c.alignTo(e.getActiveTab(),"tr-tr")}})},tabchange:function(a,b){"maintabGraph"==b.id||"maintabSystem"==b.id||"maintabConfig"==b.id}}});viewPort=Ext.create("Ext.container.Viewport",{el:"openHAB",layout:"fit",renderTo:"HABmin",hidden:!0,items:[e]}),viewPort.show(!0),Ext.get("splashscreen").fadeOut({duration:750,remove:!0}),Ext.get("HABmin").show(!0),statusTooltip=Ext.create("Ext.tip.ToolTip",{target:"onlineStatus",html:language.onlineState_Offline}),doStatus(),getReleaseVersion()}var languageCode;document.ready=function(){Ext.fly("HABminVersion").update(versionGUI,!1),languageCode=Ext.util.Cookies.get("language"),null===languageCode?languageCode="en":"UNKNOWN"==isoLanguageGetName(languageCode)&&(languageCode="en"),persistenceService=Ext.util.Cookies.get("persistence"),null==persistenceService&&(persistenceService=""),Ext.fly("HABminLanguage").update(isoLanguageGetName(languageCode),!1),"en"!=languageCode&&loadLanguage(languageCode)},Ext.Container.prototype.bufferResize=!1,Ext.Loader.setConfig({enabled:!0,disableCaching:!1,paths:{"Ext.ux":"js/extux","Ext.ux.window":"js/extux/notification","Ext.ux.aceeditor":"js/extux/aceeditor","Ext.ux.blockly":"js/extux/blockly","Ext.ux.grid":"js/extux/grid",openHAB:"app"}}),Ext.require(["Ext.tab.*","Ext.grid.*","Ext.data.*","Ext.util.*","Ext.form.*","Ext.tree.Panel","Ext.container.Viewport","Ext.selection.CellModel","Ext.layout.container.Border","Ext.layout.container.Accordion","Ext.ux.grid.QuickFilter","Ext.ux.statusbar.StatusBar","Ext.ux.aceeditor.Panel","Ext.ux.blockly.Blockly","Ext.ux.window.Notification","openHAB.graph.*","openHAB.config.*","openHAB.system.*","openHAB.automation.*"]);var versionGUI="0.1.3-snapshot",versionJAR,gitRepoLink="https://api.github.com/repos/cdjackson/HABmin/releases",viewPort,statusTooltip,STATUS_UNKNOWN=0,STATUS_ONLINE=1,STATUS_BUSY=2,STATUS_OFFLINE=3,onlineStatus=STATUS_UNKNOWN,NOTIFICATION_ERROR=1,NOTIFICATION_OK=2,NOTIFICATION_WARNING=3,NOTIFICATION_INFO=4,persistenceItemStore,persistenceServiceStore,itemTypeStore,itemIconStore,widgetStore,sitemapStore,bindingStore,itemConfigStore,itemFormatStore,translationServiceStore,ruleLibraryStore,designStore,ruleStore,cronRuleStore,chartStore,persistenceService="",HABminBaseURL="/services/habmin",userPrefs={},itemTypeArray=[{name:"GroupItem",icon:"images/category-group.png"},{name:"SwitchItem",icon:"images/switch.png"},{name:"NumberItem",icon:"images/counter.png"},{name:"ColorItem",icon:"images/color.png"},{name:"ContactItem",icon:"images/door-open.png"},{name:"DateTimeItem",icon:"images/clock.png"},{name:"DimmerItem",icon:"images/ui-slider.png"},{name:"RollershutterItem",icon:"images/curtain.png"},{name:"StringItem",icon:"images/edit.png"}],widgetTypeArray=[{type:"Group",icon:"images/ui-scroll-pane.png",iconCls:"widget-group"},{type:"Frame",icon:"images/ui-group-box.png",iconCls:"widget-frame"},{type:"Image",icon:"images/picture.png",iconCls:"widget-image"},{type:"Selection",icon:"images/ui-combo-box-blue.png",iconCls:"widget-selection"},{type:"Slider",icon:"images/ui-slider.png",iconCls:"widget-slider"},{type:"Chart",icon:"images/chart-up.png",iconCls:"widget-chart"},{type:"Video",icon:"images/film.png",iconCls:"widget-video"},{type:"Webview",icon:"images/globe.png",iconCls:"widget-webview"},{type:"Setpoint",icon:"images/ui-scroll-bar.png",iconCls:"widget-setpoint"},{type:"Switch",icon:"images/switch.png",iconCls:"widget-switch"},{type:"Colorpicker",icon:"images/color.png",iconCls:"widget-colorpicker"},{type:"Text",icon:"images/edit.png",iconCls:"widget-text"}],formatLookupArray=[{format:"%d",label:"Integer"},{format:"%.1f",label:"Float (1 decimal place)"},{format:"%.2f",label:"Float (2 decimal place)"},{format:"%.3f",label:"Float (3 decimal place)"},{format:"%b",label:"Boolean (lower case)"},{format:"%B",label:"Boolean (upper case)"},{format:"%s",label:"String (lower case)"},{format:"%S",label:"String (upper case)"},{format:"%x",label:"Hexadecimal (lower case)"},{format:"%X",label:"Hexadecimal (upper case)"},{format:"%o",label:"Octal"},{format:"%1$tR",label:"Time (HH:MM)"},{format:"%1$tT",label:"Time (HH:MM:SS)"},{format:"%1$td %1$tb %1$tY",label:"Date (dd MMM YYYY)"},{format:"%1$ta %1$td %1$tb %1$tY",label:"Date (DDD dd MMM YYYY)"},{format:"%1$ta %1$tR",label:"Day/Time (DDD HH:MM)"},{format:"%1$ta %1$tT",label:"Day/Time (DDD HH:MM:SS)"},{format:"%1$td %1$tb %1$tY %1$tR",label:"Date/Time (dd MMM YYYY HH:MM)"},{format:"%1$td %1$tb %1$tY %1$tT",label:"Date/Time (dd MMM YYYY HH:MM:SS)"},{format:"%1$tT %1$td %1$tb %1$tY",label:"Date/Time (HH:MM:SS dd MMM YYYY)"}],translationServiceArray=[{name:"",label:language.translation_None},{name:"MAP",label:language.translation_MapFile},{name:"REGEX",label:language.translation_Regex},{name:"JAVASCRIPT",label:language.translation_Javascript},{name:"EXEC",label:language.translation_Exec},{name:"XSLT",label:language.translation_XLS},{name:"XPATH",label:language.translation_XPath}],cronRuleArray=[{label:"Every 15 seconds",rule:"0/15 * * * * ?"},{label:"Every 30 seconds",rule:"0/30 * * * * ?"},{label:"Every 1 minute",rule:"0 * * * * ?"},{label:"Every 2 minutes",rule:"0 0/2 * * * ?"},{label:"Every 5 minutes",rule:"0 0/5 * * * ?"},{label:"Every 10 minutes",rule:"0 0/10 * * * ?"},{label:"Every 15 minutes",rule:"0 0/15 * * * ?"},{label:"Every 20 minutes",rule:"0 0/20 * * * ?"},{label:"Every 30 minutes",rule:"0 0/30 * * * ?"},{label:"Every 1 hour",rule:"0 0 * * * ?"},{label:"Every 2 hours",rule:"0 0 0/2 * * ?"},{label:"Every 3 hours",rule:"0 0 0/3 * * ?"},{label:"Every 6 hours",rule:"0 0 0/6 * * ?"},{label:"Every 12 hours (midday/midnight)",rule:"0 0 0/12 * * ?"},{label:"Every day at midday",rule:"0 0 12 * * ?"},{label:"Every day at midnight",rule:"0 0 0 * * ?"}];Ext.application({name:"HABmin",launch:function(){initState=0,createUI()}}),Ext.Ajax.defaultHeaders={Accept:"application/json,application/xml","Content-Type":"application/json"};var ajaxOutstandingRequestCount=0,ajaxLastSuccess;Ext.Ajax.on("beforerequest",function(){ajaxOutstandingRequestCount++}),Ext.Ajax.on("requestcomplete",function(){ajaxOutstandingRequestCount--,ajaxLastSuccess=(new Date).getTime()}),Ext.Ajax.on("requestexception",function(){ajaxOutstandingRequestCount--});