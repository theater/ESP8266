/*! HABmin 2014-06-20 */
Ext.define("Ext.ux.grid.QuickFilter",{mixins:{plugin:"Ext.AbstractPlugin"},extend:"Ext.form.field.Text",alias:"plugin.grid",buffer:500,selectSingle:!0,emptyText:"filter...",init:function(a){this.grid=a,this.emptyText=this.emptyText||"filter...",this.dock=this.dock||"top",this.filterTask=new Ext.util.DelayedTask,this.searchMap=new Ext.util.MixedCollection,this.grid.on({columnschanged:this.clear,reconfigure:function(){this.clear(),this.bindStore(this.grid.store)},scope:this}),this.bindStore(this.grid.store),a.textFilter=this,this.mixins.plugin.init.apply(this,arguments),this.initComponent(),a.addDocked(this)},bindStore:function(a){a.on({load:this.clear,bulkremove:this.onBulkRemove,clear:this.clear,update:this.onUpdate,scope:this})},onUpdate:function(a,b){this.remove(b)},remove:function(a){this.searchMap.removeAtKey(a.internalId)},clear:function(){this.searchMap.clear()},onBulkRemove:function(a,b){Ext.each(b,function(a){this.remove(a)},this)},onChange:function(){this.filterTask.cancel(),this.filterTask.delay(this.buffer,this.doFilter,this)},doFilter:function(){var a=this.normalize(this.getValue()),b=this.grid.getStore(),c=this.id+"-filter-text";Ext.isEmpty(a)?b.removeFilter(c):(a=a.split(" "),b.addFilter({id:c,filterFn:function(b){var c=!0;return Ext.each(a,function(a){return c=this.checkRecord(b,a)},this),c},scope:this})),this.afterFilter()},afterFilter:function(){var a,b=this.grid.getView(),c=this.grid.getStore(),d=this.grid.getSelectionModel();d&&b&&(d&&1===c.getCount()&&this.selectSingle&&d.select(c.first()),a=d.getSelection()[0],a&&(b.focusRow(a),this.focus()))},checkRecord:function(a,b){return this.getSearchString(a).indexOf(b)>-1},getSearchString:function(a){var b=a.internalId;if(!this.searchMap.containsKey(b)){var c,d=this.grid.getView(),e=d.getNode(a);e?c=e.innerHTML:(d.rowValues.view=d,c=d.renderRow(a,-1),delete d.rowValues.view),this.searchMap.add(b,this.normalize(Ext.String.htmlDecode(this.stripHTML(c))))}return this.searchMap.getByKey(b)},normalize:function(a){return Ext.String.trim((a+"").toLowerCase().replace(/\s+/gm," "))},stripHTML:function(a,b){return b=b||" ",Ext.String.trim((a+"").replace(/<(?:.|\n)*?>+/gm,b))}});