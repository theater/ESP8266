/*! HABmin 2014-06-20 */
Ext.define("openHAB.graph.graph",{extend:"Ext.panel.Panel",layout:"border",icon:"images/database-sql.png",id:"maintabGraph",cls:"empty",initComponent:function(){this.title=language.mainTab_Persistence,this.tooltip=language.mainTab_PersistenceTip,Highcharts.setOptions({global:{useUTC:!1}});var a=Ext.create("openHAB.graph.itemList"),b=Ext.create("openHAB.graph.graphList"),c=Ext.create("Ext.Panel",{split:!0,border:!0,region:"west",flex:1,preventHeader:!0,stateEvents:["resize"],stateId:"graphWindowSizer",stateful:!0,layout:{type:"accordion",hideCollapseTool:!0},items:[a,b]});0==Ext.is.Desktop&&(c.collapsed=!0);var d=Ext.create("openHAB.graph.graphHighcharts"),e=Ext.create("openHAB.graph.graphTable"),f=Ext.create("Ext.tab.Panel",{plain:!1,region:"center",layout:"fit",flex:3,tabPosition:"bottom",items:[d,e],listeners:{render:function(){this.tabBar.add({xtype:"tbfill"},{border:!1,id:"persistenceServiceSelect",tabTip:"Select persistence service",closable:!1,text:persistenceService,textAlign:"left",width:100,icon:"images/database-share.png",defaults:{xtype:"button",handler:function(){}},menu:{width:100,id:"persistenceServiceMenu",xtype:"menu",listeners:{click:function(a,b){persistenceService=b.text;var c=Ext.getCmp("persistenceServiceSelect");null!=c&&(c.setText(persistenceService),persistenceItemStore.filterItems(persistenceService))}}}})},beforetabchange:function(a,b){"graphTableData"==b.itemId&&e.isUpdateRequired()&&e.updateData()}}});this.items=[c,f],this.callParent()}}),Ext.define("openHAB.graph.graphHighcharts",{extend:"Ext.panel.Panel",icon:"images/chart-up.png",layout:"fit",header:!1,id:"highchartsChart",chartObject:null,initComponent:function(){function a(){n.getComponent("zoomIn").enable(),n.getComponent("zoomOut").enable(),n.getComponent("scrollLeft").enable(),n.getComponent("scrollRight").enable(),n.getComponent("viewDay").enable(),n.getComponent("viewWeek").enable(),n.getComponent("viewMonth").enable(),n.getComponent("viewYear").enable()}function b(a,b){h=(new Date).getTime(),graphInfoItems=[],graphInfoItems[1]=[],graphInfoItems[1].name="Response Time",graphInfoItems[1].value="";for(var d=0;d<i.length;d++)if(i[d].item==a&&(i[d].received=!0,null!=b))if(b.datapoints<2);else{for(var e=[],f=parseInt(b.datapoints/1e3),g=0,j=0,k=0;k<b.datapoints;k++)g++<f||(g=0,e[j]=[],e[j][0]=parseInt(b.data[k].time),e[j][1]=parseFloat(b.data[k].state),j++);i[d].data=e}for(var d=0;d<i.length;d++)if(0==i[d].received)return;c()}function c(){timeStart=(new Date).getTime();var b=m,c="";b.series=[];var d,e;d=0,e=0;for(var h=-1,l=0;l<i.length;l++)null!=i[l].data&&(h++,b.series[h]={},b.series[h].data=i[l].data,b.series[h].name=i[l].label,b.series[h].yAxis=i[l].axis,b.series[h].type=f.indexOf(i[l].chart)>-1?i[l].chart:"spline",null!=i[l].lineColor&&0!=i[l].lineColor.length&&(b.series[h].color=i[l].lineColor),null!=i[l].lineWidth&&0/0!=parseInt(i[l].lineWidth)&&(b.series[h].lineWidth=i[l].lineWidth,0!=i[l].lineWidth&&(b.series[h].states={},b.series[h].states.hover={},b.series[h].states.hover.lineWidth=i[l].lineWidth+2)),("string"==typeof i[l].legend||i[l].legend instanceof String)&&(b.series[h].showInLegend="true"==i[l].legend.toLowerCase()?!0:!1),null!=i[l].lineStyle&&0!=i[l].lineStyle.length&&(b.series[h].dashStyle=i[l].lineStyle),g.indexOf(i[l].markerSymbol)>-1&&(b.series[h].marker={},b.series[h].marker.enabled=!0,b.series[h].marker.symbol=i[l].markerSymbol,null!=i[l].markerColor&&0!=i[l].markerColor.length&&(b.series[h].marker.fillColor=i[l].markerColor,b.series[h].marker.lineColor=i[l].markerColor)),j>i[l].timestart&&(j=i[l].timestart),k<i[l].timeend&&(k=i[l].timeend));this.chartObject=new Highcharts.Chart(b),300>k-j?n.getComponent("zoomIn").disable():n.getComponent("zoomIn").enable(),graphInfoItems[2]=[],graphInfoItems[2].name="Render Time",graphInfoItems[2].value="",graphInfoItems[3]=[],graphInfoItems[3].name="Total Time",graphInfoItems[3].value="",Ext.MessageBox.hide(),a(),""!=c&&handleStatusNotification(NOTIFICATION_WARNING,"Warning: "+error)}function d(a,c,d){if(null!=a&&null!=a.items&&0!=a.items.length){l=a,null!=a.axis&&(a.axis=[].concat(a.axis)),null!=a.items&&(a.items=[].concat(a.items));{(new Date).getTime()}if(Ext.MessageBox.show({msg:language.graph_HighchartsLoading,width:100,height:40,icon:"icon-download",draggable:!1,closable:!1}),isNaN(c)&&(c=0),isNaN(d)&&(d=0),0==c||0==d){var e=Math.round((new Date).getTime());c=e-1728e5,d=e}d>Math.round((new Date).getTime())&&(d=Math.round((new Date).getTime()));var f={};f.starttime=Math.floor(c),f.endtime=Math.ceil(d),m.yAxis=[];for(var g=0;4>g;g++)m.yAxis[g]={},m.yAxis[g].title={},m.yAxis[g].title.style={},m.yAxis[g].title.text="",m.yAxis[g].labels={},m.yAxis[g].labels.style={};if(null!=a.axis)for(var g=0;g<a.axis.length;g++){var h=a.axis[g].axis-1;null!=a.axis[g].label&&0!=a.axis[g].label.length&&(m.yAxis[h].title.text=a.axis[g].label),null!=a.axis[g].minimum&&(m.yAxis[h].min=a.axis[g].minimum,m.yAxis[h].startOnTick=!1),null!=a.axis[g].maximum&&(m.yAxis[h].max=a.axis[g].maximum,m.yAxis[h].endOnTick=!1),"right"==a.axis[g].position&&(m.yAxis[h].opposite=!0),null!=a.axis[g].format&&0!=a.axis[g].format.length,null!=a.axis[g].color&&0!=a.axis[g].color.length&&(m.yAxis[h].labels.style.color=a.axis[g].color,null!=m.yAxis[h].title&&(m.yAxis[h].title.style.color=a.axis[g].color))}i=[];for(var j=0;j<l.items.length;j++)i[j]={},i[j].received=!1,i[j].item=l.items[j].item,i[j].axis=parseInt(l.items[j].axis)-1,i[j].label=l.items[j].label,i[j].chart=l.items[j].chart,i[j].legend=l.items[j].legend,i[j].lineWidth=parseInt(l.items[j].lineWidth),i[j].lineColor=l.items[j].lineColor,i[j].lineStyle=l.items[j].lineStyle,i[j].markerColor=l.items[j].markerColor,i[j].markerSymbol=l.items[j].markerSymbol,Ext.Ajax.request({url:HABminBaseURL+"/persistence/services/"+persistenceService+"/"+l.items[j].item,timeout:2e4,params:f,method:"GET",headers:{Accept:"application/json"},callback:function(a,c,d){var e=null;c&&(e=Ext.decode(d.responseText));var f=a.url.split("/");b(f[f.length-1],e)}})}}function e(a){var b=Math.round((new Date).getTime());d(l,b-864e5*a,b)}this.title=language.graph_HighchartsTitle;var f=["spline","line","area","areaspline","bar","column"],g=["circle","square","diamond","triangle","triangle-down"],h=0,i=[],j=0,k=0,l=[],m={chart:{renderTo:"chartIsHere",animation:!1,type:"spline",zoomType:"x",events:{selection:function(a){a.preventDefault(),d(l,Math.floor(a.xAxis[0].min),Math.ceil(a.xAxis[0].max))}}},credits:{enabled:!1},title:{text:null},xAxis:{type:"datetime",dateTimeLabelFormats:{month:"%e. %b",year:"%b"}},plotOptions:{spline:{lineWidth:3,states:{hover:{lineWidth:5}},marker:{states:{hover:{enabled:!0,symbol:"circle",radius:5,lineWidth:1}}}},series:{marker:{enabled:!1}}},legend:{enabled:!0},tooltip:{enabled:!0,crosshairs:!0,shared:!1,formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.dateFormat("%H:%M:%S %a %d %b %Y",this.x)+": "+Highcharts.numberFormat(this.y,2)}}},n=Ext.create("Ext.toolbar.Toolbar",{items:[{icon:"images/zoom_in.png",itemId:"zoomIn",disabled:!0,cls:"x-btn-icon",tooltip:language.graph_HighchartsZoomIn,handler:function(){var a,b,c;a=(k-j)/5,b=j+a,c=j-a,d(l,b,c)}},{icon:"images/zoom_out.png",itemId:"zoomOut",disabled:!0,cls:"x-btn-icon",tooltip:language.graph_HighchartsZoomOut,handler:function(){var a;a=(k-j)/5,d(l,j-a,k+a)}},"-",{icon:"images/calendar-select.png",itemId:"viewDay",disabled:!0,cls:"x-btn-icon",tooltip:language.graph_HighchartsDisplayDay,handler:function(){e(1)}},{icon:"images/calendar-select-week.png",itemId:"viewWeek",disabled:!0,cls:"x-btn-icon",tooltip:language.graph_HighchartsDisplayWeek,handler:function(){e(7)}},{icon:"images/calendar-select-month.png",itemId:"viewMonth",disabled:!0,cls:"x-btn-icon",tooltip:language.graph_HighchartsDisplayMonth,handler:function(){e(30)}},{icon:"images/calendar.png",itemId:"viewYear",disabled:!0,cls:"x-btn-icon",tooltip:language.graph_HighchartsDisplayYear,handler:function(){e(365)}},"-",{icon:"images/arrow_left.png",itemId:"scrollLeft",disabled:!0,cls:"x-btn-icon",tooltip:language.graph_HighchartsScrollLeft,handler:function(){var a;a=(k-j)/5,d(l,j-a,k-a)}},{icon:"images/arrow_right.png",itemId:"scrollRight",disabled:!0,cls:"x-btn-icon",tooltip:language.graph_HighchartsScrollLeft,handler:function(){var a;a=(k-j)/5,d(l,j+a,k+a)}}]}),o=Ext.create("Ext.panel.Panel",{itemId:"chartPanel",id:"chartPanel",xtype:"panel",tbar:n,flex:1,maintainFlex:!0,border:!1,layout:"fit",items:[{itemId:"chartIsHere",id:"chartIsHere",listeners:{resize:function(a,b,c){null!=this.chartObject&&this.chartObject.setSize(b,c)}}}]});this.items=o,this.callParent(),this.chartUpdate=function(a,b,c){d(a,b,c)},this.getData=function(){return i},this.getLastUpdate=function(){return h}}}),Ext.define("openHAB.graph.graphList",{extend:"Ext.panel.Panel",layout:"fit",icon:"images/system-monitor.png",initComponent:function(){function a(a,b,c){Ext.Ajax.request({url:HABminBaseURL+"/persistence/charts/"+a,timeout:1e4,method:"GET",headers:{Accept:"application/json"},success:function(a){var d=Ext.decode(a.responseText);if(null==d||0==d.length)return void handleStatusNotification(NOTIFICATION_ERROR,sprintf(language.graph_GraphListDownloadError,b));if("EDIT"==c){var e=Ext.create("openHAB.graph.saveGraph");e.setData(d),e.show()}else{var f=(new Date).getTime();Ext.getCmp("highchartsChart").chartUpdate(d,f-1e3*d.period,f)}},failure:function(){handleStatusNotification(NOTIFICATION_ERROR,sprintf(language.graph_GraphListDownloadError,b))}})}function b(a){"yes"===a&&Ext.Ajax.request({url:HABminBaseURL+"/persistence/charts/"+c,headers:{Accept:"application/json"},method:"DELETE",success:function(){handleStatusNotification(NOTIFICATION_OK,sprintf(language.graph_GraphListDeleteOk,d))},failure:function(){handleStatusNotification(NOTIFICATION_ERROR,sprintf(language.graph_GraphListDeleteError,d))},callback:function(){chartStore.reload(),e.getComponent("delete").disable(),e.getComponent("edit").disable()}})}this.title=language.graph_GraphList,this.tabTip=language.graph_GraphListTip;var c=null,d=null,e=Ext.create("Ext.toolbar.Toolbar",{items:[{icon:"images/cross.png",itemId:"delete",text:language.delete,cls:"x-btn-icon",disabled:!0,tooltip:language.graph_GraphListDeleteTip,handler:function(){Ext.Msg.show({title:language.config_ItemListConfirmDeleteTitle,msg:sprintf(language.graph_GraphListConfirmDeleteMsg,d),buttons:Ext.Msg.YESNO,config:{obj:this,name:d},fn:b,icon:Ext.MessageBox.QUESTION})}},{icon:"images/pencil-small.png",itemId:"edit",text:language.edit,cls:"x-btn-icon",disabled:!0,tooltip:language.graph_GraphListEditTip,handler:function(){null!==c&&a(c,d,"EDIT")}}]}),f=Ext.create("Ext.grid.Panel",{store:chartStore,tbar:e,header:!1,hideHeaders:!0,columns:[{menuDisabled:!0,menuText:"Data Type",sortable:!0,width:24,hidden:!1,resizable:!1,dataIndex:"icon",renderer:function(a){return""!=a?'<img src="../images/'+a+'.png" height="16">':void 0}},{text:"Item",hideable:!1,flex:1,width:75,sortable:!0,dataIndex:"name",renderer:function(a,b,c){return""!=a?a:null==c?"":c.get("name")}}],layout:"fit",viewConfig:{stripeRows:!1,enableTextSelection:!1,markDirty:!1},listeners:{itemclick:function(b,f,g){Ext.get(g);c=f.get("id"),d=f.get("name"),null!=c&&(e.getComponent("delete").enable(),e.getComponent("edit").enable(),a(c,d,"VIEW"))}}});this.items=f,this.callParent()}}),Ext.define("openHAB.graph.graphTable",{extend:"Ext.panel.Panel",layout:"fit",tabTip:"Show and edit graph data",itemId:"graphTableData",title:"Table",icon:"images/table-export.png",lastUpdate:0,deferredRender:!0,initComponent:function(){function a(a,b,c){if("yes"===a){var d={};d.time=c.config.time,Ext.Ajax.request({url:HABminBaseURL+"/persistence/"+persistenceService+"/"+c.config.item,headers:{Accept:"application/json"},params:d,method:"DELETE",success:function(){handleStatusNotification(NOTIFICATION_OK,"Record deleted")},failure:function(){handleStatusNotification(NOTIFICATION_ERROR,"Error deleting record")},callback:function(){sitemapStore.reload(),Ext.getCmp("configPropertyContainer").removeProperty(),toolbar.getComponent("delete").disable()}})}}this.callParent(),this.updateData=function(){if(null!=Ext.getCmp("highchartsChart").getLastUpdate()&&!(Ext.getCmp("highchartsChart").getLastUpdate()<this.lastUpdate)){this.lastUpdate=(new Date).getTime();var b=Ext.getCmp("highchartsChart").getData();if(null!=b&&0!=b.length){this.removeAll(),Ext.MessageBox.show({msg:"Producing table array...",width:100,height:40,icon:"icon-download",draggable:!1,closable:!1});var c=[];c[0]=[],c[0].text="Time",c[0].dataIndex="time",c[0].xtype="datecolumn",c[0].format="H:i:s d M Y",c[0].width=130;var d=[];d[0]=[],d[0].name="time",d[0].type="date",d[0].dateFormat="time";for(var e=0;e<b.length;e++)d[e+1]=[],d[e+1].name=b[e].item,c[e+1]=[],c[e+1].text=b[e].item,c[e+1].dataIndex=b[e].item,c[e+1].width=150;Ext.define("GraphTableModel",{extend:"Ext.data.Model",fields:d});var f=Ext.create("Ext.Action",{icon:"images/layer--pencil.png",text:"Edit Record",disabled:!1,handler:function(){i.contextCellIndex,i.contextRowIndex,i.getSelectionModel().getSelection()[0]}}),g=Ext.create("Ext.Action",{icon:"images/cross.png",text:"Delete Record",disabled:!1,handler:function(){var b=i.contextCellIndex,d=i.contextRowIndex,e=i.getStore();if(null!=e){var f=e.getAt(d);if(null!=f){var g=f.get("time"),h=f.get(c[b].text);Ext.Msg.show({title:"Confirm Delete",msg:"Are you sure you want to delete the selected record?<br>"+c[b].text+"<br>"+g+":"+h,buttons:Ext.Msg.YESNO,config:{obj:this,item:c[b].dataIndex,time:g,state:h},fn:a,icon:Ext.MessageBox.QUESTION})}}}}),h=Ext.create("Ext.menu.Menu",{items:[f,g]}),i=Ext.create("Ext.grid.Panel",{store:{model:"GraphTableModel",data:b[0].data},multiSelect:!1,columns:c,selType:"cellmodel",viewConfig:{stripeRows:!0,listeners:{cellcontextmenu:function(a,b,c,d,e,j,k){if(k.stopEvent(),0==c)return!1;var l=persistenceServiceStore.findExact(persistenceService);if(-1==l)return!1;var m=!1,n=[].concat(persistenceItemStore.getAt(l).get("actions"));return n=["Delete"],-1==n.indexOf("Delete")?g.disable():(g.enable(),m=!0),-1==n.indexOf("Update")?f.disable():(f.enable(),m=!0),0!=m?(i.contextCellIndex=c,i.contextRowIndex=j,h.showAt(k.getXY()),!1):void 0}}}});this.add(i),Ext.MessageBox.hide()}}},this.isUpdateRequired=function(){return Ext.getCmp("highchartsChart").getLastUpdate()<this.lastUpdate?!1:!0}}}),Ext.define("openHAB.graph.itemList",{extend:"Ext.panel.Panel",layout:"fit",icon:"images/document-node.png",initComponent:function(){function a(){var a={};a.items=[];for(var c=0;c<b.length;c++){var d={};d.item=b[c].name,d.axis=1,d.legend=!0,d.lineWidth=1;var e=persistenceItemStore.findExact("name",b[c].name);d.label=-1!=e?persistenceItemStore.getAt(e).get("label"):b[c].name,a.items.push(d)}return a}this.title=language.graph_ItemList,this.tabTip=language.graph_ItemListTip;var b=[],c=Ext.create("Ext.toolbar.Toolbar",{items:[{icon:"images/arrow-circle-225-left.png",itemId:"clear",text:language.graph_ItemListReset,cls:"x-btn-icon",disabled:!1,tooltip:language.graph_ItemListResetTip,handler:function(){d.clearSelection(),c.getComponent("update").disable(),c.getComponent("save").disable()}},{icon:"images/disk.png",itemId:"save",text:language.graph_ItemListSave,cls:"x-btn-icon",disabled:!0,tooltip:language.graph_ItemListSaveTip,handler:function(){if(0!=b.length){var c=Ext.create("openHAB.graph.saveGraph"),d=a();d.period="86400",c.setData(d),c.show()}}},{icon:"images/external.png",itemId:"update",text:language.graph_ItemListUpdate,cls:"x-btn-icon",disabled:!0,tooltip:language.graph_ItemListUpdateTip,handler:function(){0!=b.length&&Ext.getCmp("highchartsChart").chartUpdate(a())}}]}),d=Ext.create("Ext.grid.Panel",{store:persistenceItemStore,tbar:c,header:!1,disableSelection:!0,plugins:[{ptype:"grid",emptyText:language.graph_ItemListFilterDefault},{ptype:"cellediting",clicksToEdit:1}],columns:[{menuDisabled:!0,menuText:language.graph_ItemIcon,sortable:!0,width:24,hidden:!1,resizable:!1,dataIndex:"icon",renderer:function(a){return""!=a?'<img src="../images/'+a+'.png" height="16">':void 0}},{text:language.graph_ItemTitle,hideable:!1,flex:1,width:75,sortable:!0,dataIndex:"label",renderer:function(a,b,c){return""!=a?a:null==c?"":c.get("name")}},{text:language.graph_LastValue,width:75,hidden:!0,sortable:!0,dataIndex:"state"}],layout:"fit",viewConfig:{stripeRows:!1,enableTextSelection:!1,markDirty:!1,getRowClass:function(a){if(null==b)return"";for(var c=a.get("name"),d=0;d<b.length;d++)if(b[d].name==c)return"x-grid-row-selected-override";return""}},listeners:{activate:function(){persistenceItemStore.filter("type","GroupItem")},itemclick:function(a,d,e,f){if(null==b&&(b=[]),null!=e){for(var g=Ext.get(e),h=d.get("name"),i=-1,j=0;j<b.length;j++)if(b[j].name==h){i=j;break}if(-1==i){if(b.length<8){{var k={};persistenceItemStore.getCount()}k.name=h,k.axis=0,b.push(k),c.getComponent("update").enable(),c.getComponent("save").enable(),this.getView().refreshNode(f),g.frame()}}else b.splice(i,1),0==b.length&&(c.getComponent("update").disable(),c.getComponent("save").disable()),this.getView().refreshNode(f),g.frame()}}},clearSelection:function(){b=[],this.getView().refresh(),c.getComponent("update").disable(),c.getComponent("save").disable()}});this.items=d,this.callParent()}}),Ext.define("openHAB.graph.saveGraph",{extend:"Ext.window.Window",closeAction:"destroy",width:750,resizable:!1,draggable:!1,modal:!0,itemId:"saveGraph",layout:{type:"vbox",align:"stretch"},chartId:null,initComponent:function(){this.title=language.graph_SaveGraphTitle;var a=this;a.saveGraphAxisStore=Ext.create("Ext.data.Store",{fields:[{type:"number",name:"axis"},{type:"string",name:"label"},{type:"string",name:"format"},{type:"string",name:"color"},{type:"string",name:"minimum"},{type:"string",name:"maximum"},{type:"string",name:"position"}]}),a.saveGraphStore=Ext.create("Ext.data.Store",{storeId:"saveGraphStore",fields:[{type:"string",name:"item"},{type:"number",name:"axis"},{type:"string",name:"label"},{type:"string",name:"chart"},{type:"string",name:"legend"},{type:"string",name:"lineColor"},{type:"number",name:"lineWidth"},{type:"string",name:"lineStyle"},{type:"string",name:"markerColor"},{type:"string",name:"markerSymbol"}]});var b=Ext.create("Ext.data.Store",{fields:["format","label"],data:[{format:"%d",label:"Integer"},{format:"%.1f",label:"Float (0.0)"},{format:"%.2f",label:"Float (0.00)"},{format:"%.3f",label:"Float (0.000)"}]}),c=Ext.create("Ext.data.Store",{fields:["id","name"],data:[{id:"left",name:"Left"},{id:"right",name:"Right"}]}),d=Ext.create("Ext.data.Store",{fields:["id","name"],data:[{id:"line",name:language.graph_SaveGraphLine},{id:"spline",name:language.graph_SaveGraphSpline},{id:"bar",name:language.graph_SaveGraphBar},{id:"area",name:language.graph_SaveGraphArea},{id:"areaspline",name:language.graph_SaveGraphAreaSpline},{id:"column",name:language.graph_SaveGraphColumn}]}),e=Ext.create("Ext.data.Store",{fields:["icon","name"],data:[{icon:"None",name:"None"},{icon:"Solid",name:"Solid"},{icon:"ShortDash",name:"ShortDash"},{icon:"ShortDot",name:"ShortDot"},{icon:"ShortDashDot",name:"ShortDashDot"},{icon:"Dot",name:"Dot"},{icon:"ShortDashDot",name:"ShortDashDot"},{icon:"Dash",name:"Dash"},{icon:"LongDash",name:"LongDash"},{icon:"DashDot",name:"DashDot"},{icon:"LongDashDot",name:"LongDashDot"},{icon:"LongDashDotDot",name:"LongDashDotDot"}]}),f=Ext.create("Ext.data.Store",{fields:["icon","name"],data:[{icon:"none.png",name:"none"},{icon:"square.png",name:"square"},{icon:"diamond.png",name:"diamond"},{icon:"triangle.png",name:"triangle"},{icon:"triangle-down.png",name:"triangle-down"}]}),g=Ext.create("Ext.data.Store",{fields:["color"],data:[{color:"#2f7ed8"},{color:"#0d233a"},{color:"#8bbc21"},{color:"#910000"},{color:"#1aadce"},{color:"#492970"},{color:"#f28f43"},{color:"#77a1e5"},{color:"#c42525"},{color:"#a6c96a"}]}),h=Ext.create("Ext.data.Store",{fields:["period","name"],autoLoad:!0,data:[{period:"3600",name:language.graph_SaveGraphPeriod1Hour},{period:"7200",name:language.graph_SaveGraphPeriod2Hours},{period:"10800",name:language.graph_SaveGraphPeriod3Hours},{period:"14400",name:language.graph_SaveGraphPeriod4Hours},{period:"21600",name:language.graph_SaveGraphPeriod6Hours},{period:"43200",name:language.graph_SaveGraphPeriod12Hours},{period:"86400",name:language.graph_SaveGraphPeriod1Day},{period:"172800",name:language.graph_SaveGraphPeriod2Days},{period:"259200",name:language.graph_SaveGraphPeriod3Days},{period:"345600",name:language.graph_SaveGraphPeriod4Days},{period:"432000",name:language.graph_SaveGraphPeriod5Days},{period:"864000",name:language.graph_SaveGraphPeriod10Days},{period:"604800",name:language.graph_SaveGraphPeriod1Week},{period:"1209600",name:language.graph_SaveGraphPeriod2Weeks}]}),i=Ext.create("Ext.data.Store",{fields:["axis","icon"],data:[{axis:1,icon:"images/notification-counter-01.png"},{axis:2,icon:"images/notification-counter-02.png"},{axis:3,icon:"images/notification-counter-03.png"},{axis:4,icon:"images/notification-counter-04.png"}]}),j=Ext.create("Ext.data.Store",{fields:["name","icon"],data:[{name:"true",icon:"images/tick.png"},{name:"false",icon:"images/cross.png"}]}),k=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1}),l=Ext.create("Ext.grid.Panel",{store:a.saveGraphStore,selType:"cellmodel",border:!0,hideHeaders:!1,title:language.graph_SaveGraphItemConfig,header:{height:18,padding:1,titleAlign:"center"},cls:"save-chart-form",disableSelection:!0,height:195,columns:[{text:language.graph_SaveGraphItemAxis,hideable:!1,width:32,sortable:!1,dataIndex:"axis",editor:new Ext.form.field.ComboBox({editable:!1,selectOnTab:!0,store:i,displayField:"icon",valueField:"axis",displayTpl:function(){return""},listConfig:{minWidth:24,getInnerTpl:function(){return'<div><img src="{icon}" height="16"></div>'}}}),renderer:function(a){var b=i.findExact("axis",a);if(-1==b)return"";var c=i.getAt(b).get("icon");return'<img src="'+c+'" align="left" height="16">'}},{text:language.graph_SaveGraphItemItem,hideable:!1,flex:3,sortable:!1,dataIndex:"item",editor:new Ext.form.field.ComboBox({editable:!1,store:itemConfigStore,displayField:"name",valueField:"name"})},{text:language.graph_SaveGraphItemLabel,hideable:!1,flex:3,sortable:!1,dataIndex:"label",editor:{allowBlank:!0}},{text:language.graph_SaveGraphItemChart,hideable:!1,flex:2,sortable:!1,dataIndex:"chart",editor:new Ext.form.field.ComboBox({editable:!1,store:d,displayField:"name",valueField:"id"}),renderer:function(a){var b=d.findExact("id",a);return-1==b?"":d.getAt(b).get("name")}},{text:language.graph_SaveGraphItemLegend,hideable:!1,flex:1,sortable:!1,dataIndex:"legend",editor:new Ext.form.field.ComboBox({editable:!1,store:j,displayField:"icon",valueField:"name",displayTpl:function(){return""},listConfig:{minWidth:24,getInnerTpl:function(){return'<div><img src="{icon}" height="16"></div>'}}}),renderer:function(a){var b=j.findExact("name",a);if(-1==b)return"";var c=j.getAt(b).get("icon");return'<img src="'+c+'" align="left" height="16">'}},{text:language.graph_SaveGraphItemLine,height:40,sortable:!1,flex:4.5,hideable:!1,columns:[{text:language.graph_SaveGraphItemLineColor,hideable:!1,flex:1,sortable:!1,dataIndex:"lineColor",editor:new Ext.form.field.ComboBox({editable:!1,store:g,displayField:"color",valueField:"color",displayTpl:function(){return""},listConfig:{getInnerTpl:function(){return'<div style="background-color:{color};text-align:center;">&nbsp</div>'}}}),renderer:function(a){return'<div style="background-color:'+a+';text-align:center;">&nbsp</div>'}},{text:language.graph_SaveGraphItemLineWidth,hideable:!1,flex:1.5,sortable:!1,dataIndex:"lineWidth",editor:{xtype:"numberfield",minValue:0,maxValue:12,allowDecimals:!1,keyNavEnabled:!1,mouseWheelEnabled:!1}},{text:language.graph_SaveGraphItemLineStyle,hideable:!1,dataIndex:"lineStyle",flex:1.5,sortable:!1,editor:new Ext.form.field.ComboBox({editable:!1,store:e,displayField:"name",valueField:"name"}),renderer:function(a){var b=e.findExact("name",a);return-1==b?"":e.getAt(b).get("name")}}]},{text:language.graph_SaveGraphItemMarker,height:40,hideable:!1,flex:3,sortable:!1,columns:[{text:language.graph_SaveGraphItemMarkerColor,hideable:!1,flex:1.5,sortable:!1,dataIndex:"markerColor",editor:new Ext.form.field.ComboBox({editable:!1,store:g,displayField:"color",valueField:"color",displayTpl:function(){return""},listConfig:{getInnerTpl:function(){return'<div style="background-color:{color};text-align:center;">&nbsp</div>'}}}),renderer:function(a){return'<div style="background-color:'+a+';text-align:center;">&nbsp</div>'}},{text:language.graph_SaveGraphItemMarkerSymbol,hideable:!1,dataIndex:"markerSymbol",flex:1.5,sortable:!1,editor:new Ext.form.field.ComboBox({editable:!1,store:f,displayField:"name",valueField:"name"}),renderer:function(a){var b=f.findExact("name",a);return-1==b?"":f.getAt(b).get("name")}}]}],layout:"fit",viewConfig:{stripeRows:!1,enableTextSelection:!1,markDirty:!1},plugins:[k]}),m=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1}),n=Ext.create("Ext.grid.Panel",{store:a.saveGraphAxisStore,title:language.graph_SaveGraphAxisConfig,flex:3,border:!0,selType:"cellmodel",hideHeaders:!1,header:{height:18,padding:1,titleAlign:"center"},cls:"save-chart-form",disableSelection:!0,columns:[{text:language.graph_SaveGraphAxisAxis,hideable:!1,width:32,sortable:!1,dataIndex:"axis",renderer:function(a){var b=i.findExact("axis",a);if(-1==b)return"";var c=i.getAt(b).get("icon");return'<img src="'+c+'" align="left" height="16">'}},{text:language.graph_SaveGraphAxisTitle,hideable:!1,flex:6,sortable:!1,dataIndex:"label",editor:{allowBlank:!0}},{text:language.graph_SaveGraphAxisFormat,hideable:!1,flex:3,sortable:!1,dataIndex:"format",editor:new Ext.form.field.ComboBox({editable:!1,store:b,displayField:"label",valueField:"format"}),renderer:function(a){var c=b.findExact("format",a);return-1==c?"":b.getAt(c).get("label")}},{text:language.graph_SaveGraphAxisColor,hideable:!1,flex:1,sortable:!1,dataIndex:"color",editor:new Ext.form.field.ComboBox({editable:!1,store:g,displayField:"color",valueField:"color",displayTpl:function(){return""},listConfig:{getInnerTpl:function(){return'<div style="background-color:{color};text-align:center;">&nbsp</div>'}}}),renderer:function(a){return'<div style="background-color:'+a+';text-align:center;">&nbsp</div>'}},{text:language.graph_SaveGraphAxisMinimum,hideable:!1,flex:2,sortable:!1,dataIndex:"minimum",editor:{maskRe:/[0-9.-]/,allowBlank:!0,validator:function(a){return isNaN(a)?language.graph_SaveGraphAxisNumberError:!0}}},{text:language.graph_SaveGraphAxisMaximum,hideable:!1,flex:2,sortable:!1,dataIndex:"maximum",editor:{maskRe:/[0-9.-]/,allowBlank:!0,validator:function(a){return isNaN(a)?language.graph_SaveGraphAxisNumberError:!0}}},{text:language.graph_SaveGraphAxisPosition,hideable:!1,flex:2,sortable:!1,dataIndex:"position",editor:new Ext.form.field.ComboBox({editable:!1,store:c,displayField:"name",valueField:"id"}),renderer:function(a){var b=c.findExact("id",a);return-1==b?"":c.getAt(b).get("name")}}],layout:"fit",viewConfig:{stripeRows:!1,enableTextSelection:!1,markDirty:!1},plugins:[m]});a.chartForm=Ext.create("Ext.form.Panel",{xtype:"form",flex:2,header:{height:18,padding:1,titleAlign:"center"},cls:"save-chart-form",title:language.graph_SaveGraphChartConfig,border:!0,bodyPadding:10,fieldDefaults:{labelAlign:"left",labelWidth:60,labelStyle:"font-weight:bold",anchor:"100%"},items:[{xtype:"textfield",name:"name",fieldLabel:language.graph_SaveGraphName,maxLength:50,enforceMaxLength:!0,allowBlank:!1},{xtype:"combobox",name:"period",fieldLabel:language.graph_SaveGraphPeriod,allowBlank:!1,valueField:"period",displayField:"name",queryMode:"local",editable:!1,store:h},{xtype:"combobox",fieldLabel:language.graph_SaveGraphIcon,name:"icon",store:itemIconStore,allowBlank:!1,valueField:"name",displayField:"label",forceSelection:!0,editable:!1,queryMode:"local",listConfig:{getInnerTpl:function(){var a='<div><img src="../images/{menuicon}" align="left" height="16">&nbsp;&nbsp;{label}</div>';return a}}}]});var o=Ext.create("Ext.panel.Panel",{layout:{type:"hbox",align:"stretch"},flex:1,border:!1,items:[a.chartForm,n]});this.items=[o,l],this.callParent(),this.setData=function(b){if(null!=b&&null!=b.items&&0!=b.items.length){for(var c=0;c<b.items.length;c++)null==b.items[c].legend&&(b.items[c].legend="true");var d=a.chartForm.getForm();null!=d&&d.setValues(b),this.chartId=b.id;var e=[{axis:1,position:"left"},{axis:2,position:"left"},{axis:3,position:"left"},{axis:4,position:"left"}];if(null!=b.axis){b.axis=[].concat(b.axis);for(var f=0;f<b.axis.length;f++)e[b.axis[f].axis-1]=b.axis[f]}a.saveGraphAxisStore.loadData(e),null!=b.items&&(b.items=[].concat(b.items),a.saveGraphStore.loadData(b.items))}}},buttons:[{text:language.cancel,handler:function(){this.up("window").destroy()}},{text:language.save,handler:function(){var a=this.up("#saveGraph");if(0!=a.chartForm.isValid()){var b={},c=a.chartForm.getValues();b.name=c.name,b.icon=c.icon,b.period=c.period,b.items=[];for(var d=a.saveGraphStore.getRange(),e=0;e<d.length;e++){var f={};f.item=d[e].get("item"),f.axis=d[e].get("axis"),f.label=d[e].get("label"),f.chart=d[e].get("chart"),f.legend=d[e].get("legend"),f.lineWidth=d[e].get("lineWidth"),f.lineStyle=d[e].get("lineStyle"),f.lineColor=d[e].get("lineColor"),f.markerColor=d[e].get("markerColor"),f.markerSymbol=d[e].get("markerSymbol"),b.items.push(f)}b.axis=[];for(var d=a.saveGraphAxisStore.getRange(),e=0;e<d.length;e++){var g={};g.axis=d[e].get("axis"),g.label=d[e].get("label"),g.color=d[e].get("color"),g.format=d[e].get("format"),g.minimum=d[e].get("minimum"),g.maximum=d[e].get("maximum"),g.position=d[e].get("position"),(""!=g.label||""!=g.format||""!=g.minimum||""!=g.maximum||"left"!=g.position)&&b.axis.push(g)}b.id=a.chartId;var h="POST",i="";null!=b.id&&0!=b.id&&(h="PUT",i="/"+b.id),Ext.Ajax.request({url:HABminBaseURL+"/persistence/charts"+i,jsonData:b,method:h,success:function(a){handleStatusNotification(NOTIFICATION_OK,sprintf(language.graph_SaveGraphSuccess,b.name));Ext.decode(a.responseText)},failure:function(){handleStatusNotification(NOTIFICATION_ERROR,sprintf(language.graph_SaveGraphError,b.name))},callback:function(){chartStore.reload()}}),this.up("window").destroy()}}}]});